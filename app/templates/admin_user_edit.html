<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit User - Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function toggleFields() {
            const role = document.getElementById('role').value;
            const extraFields = document.getElementById('extra-fields');
            const instIdLabel = document.getElementById('inst-id-label');
            const deptInput = document.getElementById('department');
            const instIdInput = document.getElementById('institution_id');

            const positionField = document.getElementById('position-field');

            if (role === 'admin') {
                // Admin: Fields visible but optional
                extraFields.style.display = 'contents';
                positionField.style.display = 'none';
                deptInput.required = false;
                instIdInput.required = false;
                instIdLabel.innerText = "Institution ID (Optional)";
            } else if (role === 'faculty') {
                extraFields.style.display = 'contents';
                positionField.style.display = 'block';
                deptInput.required = true;
                instIdInput.required = true;
                instIdLabel.innerText = "Institution ID (Faculty ID)";
            } else if (role === 'student') {
                extraFields.style.display = 'contents';
                positionField.style.display = 'none';
                deptInput.required = true;
                instIdInput.required = true;
                instIdLabel.innerText = "Institution ID (Roll Number)";
            }
        }

        window.onload = toggleFields;
    </script>
</head>

<body>

    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Edit User</h1>
                <p class="text-muted">Editing: {{ user.full_name }} ({{ user.email }})</p>
            </div>
            <div>
                <a href="{{ url_for('admin.users_dashboard') }}" class="btn btn-outline-primary">Back to List</a>
            </div>
        </header>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-danger">
            {% for message in messages %}
            <div>{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="card">
            <div class="card-body">
                <form method="post" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="full_name" class="form-control" required value="{{ user.full_name }}">
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" class="form-control" required value="{{ user.email }}">
                    </div>

                    <div class="form-group">
                        <label>Role</label>
                        <select name="role" id="role" class="form-control" onchange="toggleFields()">
                            <option value="student" {% if user.role=='student' %}selected{% endif %}>Student</option>
                            <option value="faculty" {% if user.role=='faculty' %}selected{% endif %}>Faculty</option>
                            <option value="admin" {% if user.role=='admin' %}selected{% endif %}>Admin</option>
                        </select>
                    </div>

                    <div class="form-group" id="position-field" style="display: none;">
                        <label>Position (Optional)</label>
                        <input type="text" name="position" class="form-control" value="{{ user.position or '' }}"
                            placeholder="e.g. hod">
                    </div>

                    <div class="form-group">
                        <label>New Password <small class="text-muted">(Leave blank to keep current)</small></label>
                        <input type="password" name="password" class="form-control" placeholder="New Password">
                    </div>

                    <div id="extra-fields" style="display: contents;">
                        <div class="form-group">
                            <label id="inst-id-label">Institution ID</label>
                            <input type="text" name="institution_id" id="institution_id" class="form-control"
                                value="{{ user.institution_id or '' }}">
                        </div>

                        <div class="form-group">
                            <label>Department</label>
                            <input type="text" name="department" id="department" class="form-control"
                                value="{{ user.department or '' }}">
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="is_active" {% if user.is_active %}checked{% endif %}>
                            <span>Account Active?</span>
                        </label>
                    </div>

                    <div style="grid-column: span 2;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Update User</button>
                        <a href="{{ url_for('admin.users_dashboard') }}" class="btn btn-secondary"
                            style="width: 100%; margin-top: 0.5rem; display: block; text-align: center;">Cancel</a>
                    </div>
                </form>
            </div>
        </div>

    </div>

</body>

</html>