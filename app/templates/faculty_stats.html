<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Insights - {{ current_user.department }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-light">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="navbar-brand">üìä Dept. Insights: {{ current_user.department }}</div>
            <div class="d-flex gap-2">

                <a href="{{ url_for('main.faculty_dashboard') }}" class="btn btn-sm btn-outline-primary">Back to
                    Dashboard</a>
                <a href="{{ url_for('main.logout') }}" class="btn btn-sm btn-danger">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <!-- KPIs -->
        <h4 class="mb-3">Overview</h4>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="facultyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                    type="button" role="tab">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button"
                    role="tab">Trends</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button"
                    role="tab">Events Data</button>
            </li>
        </ul>

        <div class="tab-content" id="facultyTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary mb-3 clickable-card"
                            onclick="showStatsModal('participation')" style="cursor:pointer;"
                            title="Click to see student participation">
                            <div class="card-body">
                                <h5 class="card-title">Total Students <small>üîç</small></h5>
                                <p class="card-text display-6">{{ total_students }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success mb-3 clickable-card"
                            onclick="showStatsModal('activities')" style="cursor:pointer;"
                            title="Click to see all activities">
                            <div class="card-body">
                                <h5 class="card-title">Dept. Events <small>üîç</small></h5>
                                <p class="card-text display-6">{{ total_events }}</p>
                                <small>(Click to view)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info mb-3 clickable-card" onclick="showStatsModal('verified')"
                            style="cursor:pointer;" title="Click to see verified certificates">
                            <div class="card-body">
                                <h5 class="card-title">Verified Certs <small>üîç</small></h5>
                                <p class="card-text display-6">{{ status_counts.get('faculty_verified', 0) +
                                    status_counts.get('auto_verified', 0) }}</p>
                                <small>(Click to view)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-warning mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Pending</h5>
                                <p class="card-text display-6">{{ status_counts.get('pending', 0) }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interactive Insights Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div
                                class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <span>üìä Department Insights</span>
                                <button class="btn btn-sm btn-light" onclick="resetInsights()">Reset View</button>
                            </div>
                            <div class="card-body">
                                <!-- Breadcrumbs -->
                                <nav aria-label="breadcrumb" class="mb-3">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="#"
                                                onclick="resetInsights(); return false;">Activity Types</a></li>
                                        <li class="breadcrumb-item active" id="bread-event" style="display:none">Events
                                        </li>
                                    </ol>
                                </nav>

                                <!-- Level 1: Activity Types -->
                                <div id="level-1-types">
                                    <h5 class="card-title text-muted mb-3">Activity Overview</h5>
                                    <div class="row">
                                        <div class="col-md-5">
                                            <div style="height: 250px;">
                                                <canvas id="typeChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-7">
                                            <div class="table-responsive">
                                                <table class="table table-hover table-sm">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Activity Type</th>
                                                            <th>Events</th>
                                                            <th>Certificates</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for t in activity_types %}
                                                        <tr>
                                                            <td><strong>{{ t.name }}</strong></td>
                                                            <td>
                                                                <span class="badge bg-secondary">{{
                                                                    type_stats.get(t.name, 0)
                                                                    }}</span>
                                                            </td>
                                                            <td>{{ type_stats.get(t.name, 0) }}</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-primary"
                                                                    onclick="loadTypeEvents({{ t.id }}, '{{ t.name }}')">
                                                                    View Events
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Level 2: Events List -->
                                <div id="level-2-events" style="display:none;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="card-title mb-0">Events in <span id="selected-type-name"
                                                class="text-primary"></span>
                                        </h5>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="resetInsights()">Back
                                            to
                                            Types</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Organizer</th>
                                                    <th>Date</th>
                                                    <th>Participants</th>
                                                    <th>Approved</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="events-table-body">
                                                <!-- Populated via JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Overview Tab -->

            <!-- Trends Tab -->
            <div class="tab-pane fade" id="trends" role="tabpanel" aria-labelledby="trends-tab">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-graph-up-arrow"></i> Certificates Over Time
                            </div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <canvas id="timeseriesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-pie-chart"></i> Verification Mode
                            </div>
                            <div class="card-body">
                                <div style="height: 350px;">
                                    <canvas id="modeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tab -->
            <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">

                <!-- Recent Activity (Horizontal Row) -->
                <div class="card mb-4">
                    <div class="card-header">Recent Activity (Last 10)</div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                            {% for act in recent_activities %}
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ act.student.full_name }}</strong> submitted <em>{{ act.title }}</em>
                                        <br><small class="text-muted">{{ act.created_at.strftime('%Y-%m-%d') }}</small>
                                    </div>
                                    <span
                                        class="badge {{ 'bg-success' if act.status == 'faculty_verified' else 'bg-warning' if act.status == 'pending' else 'bg-danger' }}">
                                        {{ act.status }}
                                    </span>
                                </div>
                            </li>
                            {% else %}
                            <li class="list-group-item text-muted">No recent activity.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Department Events Table -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Department Events</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Event Title</th>
                                        <th>Organizer</th>
                                        <th>Type</th>
                                        <th>Participants</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for evt in events_list %}
                                    <tr>
                                        <td>{{ evt.issue_date }}</td>
                                        <td>{{ evt.title }}</td>
                                        <td>{{ evt.organizer or '-' }}</td>
                                        <td><span class="badge bg-secondary">{{ evt.type_name }}</span></td>
                                        <td>
                                            {{ evt.verified_count }} / {{ evt.participant_count }}
                                            <div class="progress" style="height: 5px; width: 50px;">
                                                <div class="progress-bar bg-success" role="progressbar"
                                                    style="width: {{ (evt.verified_count / evt.participant_count * 100) if evt.participant_count > 0 else 0 }}%">
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary"
                                                onclick="showParticipantsModal('{{ evt.title }}', '{{ evt.organizer or '' }}', '{{ evt.issue_date }}')">
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No events found for this department.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div> <!-- End Data Tab -->
    </div> <!-- End Tab Content -->
    </div>

    <!-- Participants Modal -->
    <div class="modal fade" id="participantsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEventTitle">Event Participants</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" id="modalSearch" class="form-control" placeholder="Search name/roll...">
                        </div>
                        <div class="col-md-2">
                            <select id="modalStatus" class="form-control">
                                <option value="">All Status</option>
                                <option value="faculty_verified">Verified</option>
                                <option value="pending">Pending</option>
                                <option value="rejected">Rejected</option>
                                <option value="not_submitted">Not Submitted</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="modalBatch" class="form-control">
                                <option value="">All Batches</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" onclick="applyModalFilters()">Filter</button>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-success" onclick="exportModalCSV()">üì• Export CSV</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="row mb-3" id="modalStats">
                        <div class="col"><span class="badge bg-primary" id="statTotal">Total: 0</span></div>
                        <div class="col"><span class="badge bg-success" id="statVerified">Verified: 0</span></div>
                        <div class="col"><span class="badge bg-warning" id="statPending">Pending: 0</span></div>
                        <div class="col"><span class="badge bg-danger" id="statRejected">Rejected: 0</span></div>
                        <div class="col"><span class="badge bg-secondary" id="statNotSubmitted">Not Submitted: 0</span>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab"
                                href="#tabParticipatedSubmitted">‚úÖ Participated + Submitted</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabParticipatedNoCert">‚è≥
                                Participated, No Cert</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabNotParticipated">‚ùå Not
                                Participated</a></li>
                    </ul>
                    <div class="tab-content pt-3">
                        <div class="tab-pane fade show active" id="tabParticipatedSubmitted">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Roll No</th>
                                        <th>Batch</th>
                                        <th>Status</th>
                                        <th>Updated</th>
                                    </tr>
                                </thead>
                                <tbody id="participatedSubmittedTableBody"></tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="tabParticipatedNoCert">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Roll No</th>
                                        <th>Batch</th>
                                        <th>Status</th>
                                        <th>Updated</th>
                                    </tr>
                                </thead>
                                <tbody id="participatedNoCertTableBody"></tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="tabNotParticipated">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Roll No</th>
                                        <th>Batch</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="notParticipatedTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats List Modal (for clickable cards) -->
    <div class="modal fade" id="statsListModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalTitle">Data List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" id="statsSearch" class="form-control" placeholder="Search...">
                        </div>
                        <div class="col-md-2">
                            <select id="statsBatchFilter" class="form-control">
                                <option value="">All Batches</option>
                                {% for batch in batches %}
                                <option value="{{ batch }}">{{ batch }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" onclick="loadStatsData()">Filter</button>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check mt-2" id="zeroParticipationDiv" style="display:none;">
                                <input type="checkbox" class="form-check-input" id="zeroParticipationCheck">
                                <label class="form-check-label" for="zeroParticipationCheck">Zero Participation</label>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-success" onclick="exportStatsCSV()">üì• Export CSV</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="mb-3">
                        <span class="badge bg-primary" id="statsTotal">Total: 0</span>
                        <span class="badge bg-secondary" id="statsPage">Page: 1</span>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead id="statsTableHead"></thead>
                            <tbody id="statsTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav id="statsPagination" class="mt-3">
                        <ul class="pagination justify-content-center" id="statsPaginationList"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Stats Modal State
        let currentStatsType = '';
        let statsModalData = [];
        let statsPage = 1;

        function showStatsModal(type) {
            currentStatsType = type;
            statsPage = 1;

            const titles = {
                'activities': 'üìã All Department Activities',
                'verified': '‚úÖ Verified Certificates',
                'participation': 'üë• Student Participation'
            };

            document.getElementById('statsModalTitle').textContent = titles[type] || 'Data List';
            document.getElementById('statsSearch').value = '';
            document.getElementById('statsBatchFilter').value = '';

            // Show/hide zero participation checkbox
            document.getElementById('zeroParticipationDiv').style.display = type === 'participation' ? 'inline-block' : 'none';
            document.getElementById('zeroParticipationCheck').checked = false;

            loadStatsData();
            new bootstrap.Modal(document.getElementById('statsListModal')).show();
        }

        function loadStatsData(page = 1) {
            statsPage = page;
            const search = document.getElementById('statsSearch').value;
            const batch = document.getElementById('statsBatchFilter').value;
            const zeroParticipation = document.getElementById('zeroParticipationCheck').checked;

            const params = new URLSearchParams({ search, batch_year: batch, page });
            if (currentStatsType === 'participation' && zeroParticipation) {
                params.append('zero_participation', 'true');
            }

            fetch(`/api/stats/${currentStatsType}?${params}`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error('Network response was not ok: ' + r.status);
                    }
                    return r.json();
                })
                .then(data => {
                    statsModalData = data;
                    renderStatsTable(data);
                    renderStatsPagination(data);
                })
                .catch(err => {
                    console.error('Stats API Error:', err);
                    document.getElementById('statsTableBody').innerHTML =
                        '<tr><td colspan="8" class="text-danger text-center">Error loading data. Please refresh and try again.</td></tr>';
                });
        }

        function renderStatsTable(data) {
            const thead = document.getElementById('statsTableHead');
            const tbody = document.getElementById('statsTableBody');

            // Define columns based on type
            let columns = [];
            let rows = [];

            if (currentStatsType === 'activities') {
                columns = ['Event', 'Organizer', 'Date', 'Type', 'Participants', 'Approved', 'Pending', 'Rejected'];
                rows = (data.activities || []).map(a => [
                    a.title, a.organizer, a.date, a.type, a.participants, a.approved, a.pending, a.rejected
                ]);
            } else if (currentStatsType === 'verified') {
                columns = ['Student', 'Roll No', 'Batch', 'Event', 'Cert ID', 'Approval Date', 'Verifier'];
                rows = (data.verified || []).map(v => [
                    v.student_name, v.roll_number, v.batch_year, v.event_name, v.cert_id, v.approval_date, v.verifier
                ]);
            } else if (currentStatsType === 'participation') {
                columns = ['Student', 'Roll No', 'Batch', 'Events', 'Submitted', 'Approved', 'Rejected', 'Last Activity'];
                rows = (data.participation || []).map(p => [
                    p.student_name, p.roll_number, p.batch_year, p.events_participated, p.submitted, p.approved, p.rejected, p.last_activity
                ]);
            }

            thead.innerHTML = `<tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>`;
            tbody.innerHTML = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')
                || '<tr><td colspan="' + columns.length + '" class="text-muted text-center">No data found</td></tr>';

            document.getElementById('statsTotal').textContent = `Total: ${data.total || 0}`;
            document.getElementById('statsPage').textContent = `Page: ${data.page || 1} / ${data.total_pages || 1}`;
        }

        function renderStatsPagination(data) {
            const ul = document.getElementById('statsPaginationList');
            const totalPages = data.total_pages || 1;
            const currentPage = data.page || 1;

            let html = '';
            if (currentPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadStatsData(${currentPage - 1}); return false;">Prev</a></li>`;
            }
            for (let p = Math.max(1, currentPage - 2); p <= Math.min(totalPages, currentPage + 2); p++) {
                html += `<li class="page-item ${p === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="loadStatsData(${p}); return false;">${p}</a></li>`;
            }
            if (currentPage < totalPages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadStatsData(${currentPage + 1}); return false;">Next</a></li>`;
            }
            ul.innerHTML = html;
        }

        function exportStatsCSV() {
            let columns = [];
            let rows = [];

            if (currentStatsType === 'activities') {
                columns = ['Event', 'Organizer', 'Date', 'Type', 'Participants', 'Approved', 'Pending', 'Rejected'];
                rows = (statsModalData.activities || []).map(a => [a.title, a.organizer, a.date, a.type, a.participants, a.approved, a.pending, a.rejected]);
            } else if (currentStatsType === 'verified') {
                columns = ['Student', 'Roll No', 'Batch', 'Event', 'Cert ID', 'Approval Date', 'Verifier'];
                rows = (statsModalData.verified || []).map(v => [v.student_name, v.roll_number, v.batch_year, v.event_name, v.cert_id, v.approval_date, v.verifier]);
            } else if (currentStatsType === 'participation') {
                columns = ['Student', 'Roll No', 'Batch', 'Events', 'Submitted', 'Approved', 'Rejected', 'Last Activity'];
                rows = (statsModalData.participation || []).map(p => [p.student_name, p.roll_number, p.batch_year, p.events_participated, p.submitted, p.approved, p.rejected, p.last_activity]);
            }

            const csv = [columns, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${currentStatsType}_export.csv`;
            a.click();
        }

        // --- Interactive Insights Logic ---

        let typeChart = null;
        let activityTypes = {};

        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Type Chart
            initTypeChart();

            // Tab Event Listeners
            var triggerTabList = [].slice.call(document.querySelectorAll('#facultyTabs button'))
            triggerTabList.forEach(function (triggerEl) {
                var tabTrigger = new bootstrap.Tab(triggerEl)
                triggerEl.addEventListener('shown.bs.tab', function (event) {
                    if (event.target.id === 'trends-tab') {
                        loadTrendsData();
                    }
                })
            })
        });

        // --- Trends Logic ---
        let timeseriesChart = null;
        let modeChart = null;

        function loadTrendsData() {
            const params = new URLSearchParams(window.location.search);
            // Append current department not needed as user is faculty

            // 1. Timeseries
            fetch(`/api/insights/certificates-timeseries?${params.toString()}`)
                .then(r => r.json())
                .then(data => {
                    initTimeseriesChart(data);
                });

            // 2. Mode Distribution
            fetch(`/api/insights/certificate-metrics?${params.toString()}`)
                .then(r => r.json())
                .then(data => {
                    initModeChart(data.verification_mode_distribution);
                });
        }

        function initTimeseriesChart(data) {
            if (timeseriesChart) timeseriesChart.destroy();
            const ctx = document.getElementById('timeseriesChart').getContext('2d');
            timeseriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [
                        { label: 'Submitted', data: data.submitted, borderColor: '#0d6efd', fill: false, tension: 0.3 },
                        { label: 'Approved', data: data.approved, borderColor: '#198754', fill: false, tension: 0.3 },
                        { label: 'Rejected', data: data.rejected, borderColor: '#dc3545', fill: false, tension: 0.3 },
                        { label: 'Pending', data: data.pending, borderColor: '#ffc107', fill: false, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function initModeChart(dist) {
            if (modeChart) modeChart.destroy();
            const ctx = document.getElementById('modeChart').getContext('2d');

            // Combine auto_verified and faculty_verified per user request
            const verified = (dist.auto_verified || 0) + (dist.faculty_verified || 0);

            modeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Verified'],
                    datasets: [{
                        data: [verified],
                        backgroundColor: ['#198754'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Verified: ${context.parsed} (${dist.auto_verified || 0} auto + ${dist.faculty_verified || 0} manual)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Type Data Injection
        // Faculty template might not have 'activity_types' in context if not passed.
        // I need to check routes.py 'faculty_dashboard_stats' to be sure.
        // Assuming it is passed as it is common.
        const typeData = [
            {% for t in activity_types %}
        { id: { { t.id } }, name: "{{ t.name }}" },
        {% endfor %}
        ];
        // And match with stats
        // The context has `status_counts` and `recent_activities`.
        // Does it have `type_stats`? I need to check routes.py.
        // If not, I might need to fetch it or rely on what's available.
        // Let's assume I'll update routes.py if missing.
        const typeStats = {
            {% for name, count in type_stats %}
        "{{ name }}": { { count } },
        {% endfor %}
        };

        function initTypeChart() {
            const labels = typeData.map(t => t.name);
            const data = typeData.map(t => typeStats[t.name] || 0);

            if (typeChart) typeChart.destroy();

            typeChart = new Chart(document.getElementById('typeChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'My/Dept Events by Type',
                        data: data,
                        backgroundColor: '#4e73df'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const type = typeData[idx];
                            loadTypeEvents(type.id, type.name);
                        }
                    }
                }
            });
        }

        function resetInsights() {
            document.getElementById('level-1-types').style.display = 'block';
            document.getElementById('level-2-events').style.display = 'none';
            document.getElementById('bread-event').style.display = 'none';
        }

        function loadTypeEvents(typeId, typeName) {
            // UI Update
            document.getElementById('level-1-types').style.display = 'none';
            document.getElementById('level-2-events').style.display = 'block';
            document.getElementById('selected-type-name').textContent = typeName;

            const bread = document.getElementById('bread-event');
            bread.style.display = 'block';
            bread.innerHTML = `Events in ${typeName}`;
            bread.onclick = () => { resetInsights(); return false; };

            // Fetch Data
            fetch(`/api/activity_type/${typeId}/events`)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('events-table-body');
                    if (!data.events || data.events.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No events found.</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.events.map(e => `
                        <tr>
                            <td><strong>${e.title}</strong></td>
                            <td>${e.organizer}</td>
                            <td>${e.date}</td>
                            <td>${e.participating_students}</td>
                            <td><span class="badge bg-success">${e.approved}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                    onclick="showParticipantsModal('${e.title}', '${e.organizer}', '${e.date}')">
                                    View Participants
                                </button>
                            </td>
                        </tr>
                    `).join('');
                });
        }

        // Modal state
        let currentEvent = { title: '', organizer: '', date: '' };
        let modalData = { submitted: [], not_submitted: [] };

        function showParticipantsModal(title, organizer, date) {
            currentEvent = { title, organizer, date };
            document.getElementById('modalEventTitle').textContent = `Participants: ${title}`;
            document.getElementById('modalSearch').value = '';
            document.getElementById('modalStatus').value = '';
            document.getElementById('modalBatch').value = '';
            loadParticipants();
            new bootstrap.Modal(document.getElementById('participantsModal')).show();
        }

        function loadParticipants() {
            const params = new URLSearchParams({
                title: currentEvent.title,
                organizer: currentEvent.organizer,
                date: currentEvent.date,
                search: document.getElementById('modalSearch').value,
                status: document.getElementById('modalStatus').value,
                batch_year: document.getElementById('modalBatch').value
            });

            fetch(`/api/event/participants?${params}`)
                .then(r => r.json())
                .then(data => {
                    modalData = data;
                    renderModalTables(data);
                    updateModalStats(data.stats);
                });
        }

        function applyModalFilters() {
            loadParticipants();
        }

        function renderModalTables(data) {
            const participatedSubmittedBody = document.getElementById('participatedSubmittedTableBody');
            const participatedNoCertBody = document.getElementById('participatedNoCertTableBody');
            const notParticipatedBody = document.getElementById('notParticipatedTableBody');

            const statusBadge = (s) => {
                const colors = { faculty_verified: 'success', auto_verified: 'success', pending: 'warning', rejected: 'danger', not_participated: 'secondary' };
                const labels = { faculty_verified: 'Verified', auto_verified: 'Auto-Verified', pending: 'Pending', rejected: 'Rejected', not_participated: 'Not Participated' };
                return `<span class="badge bg-${colors[s] || 'secondary'}">${labels[s] || s}</span>`;
            };

            // Tab 1: Participated + Submitted (verified)
            participatedSubmittedBody.innerHTML = (data.participated_submitted || []).map(s => `
                <tr><td>${s.full_name}</td><td>${s.institution_id}</td><td>${s.batch_year}</td><td>${statusBadge(s.status)}</td><td>${s.updated_at || '-'}</td></tr>
            `).join('') || '<tr><td colspan="5" class="text-muted text-center">No verified submissions</td></tr>';

            // Tab 2: Participated, No Cert (pending/rejected)
            participatedNoCertBody.innerHTML = (data.participated_no_cert || []).map(s => `
                <tr><td>${s.full_name}</td><td>${s.institution_id}</td><td>${s.batch_year}</td><td>${statusBadge(s.status)}</td><td>${s.updated_at || '-'}</td></tr>
            `).join('') || '<tr><td colspan="5" class="text-muted text-center">No pending submissions</td></tr>';

            // Tab 3: Not Participated
            notParticipatedBody.innerHTML = (data.not_participated || []).map(s => `
                <tr><td>${s.full_name}</td><td>${s.institution_id}</td><td>${s.batch_year}</td><td>${statusBadge('not_participated')}</td></tr>
            `).join('') || '<tr><td colspan="4" class="text-muted text-center">All students participated</td></tr>';
        }

        function updateModalStats(stats) {
            document.getElementById('statTotal').textContent = `Total: ${stats.total_students}`;
            document.getElementById('statVerified').textContent = `Verified: ${stats.verified_count}`;
            document.getElementById('statPending').textContent = `Pending: ${stats.pending_count}`;
            document.getElementById('statRejected').textContent = `Rejected: ${stats.rejected_count}`;
            document.getElementById('statNotSubmitted').textContent = `Not Submitted: ${stats.not_submitted_count}`;
        }

        function exportModalCSV() {
            const rows = [['Name', 'Roll No', 'Batch', 'Status', 'Updated']];
            (modalData.participated_submitted || []).forEach(s => rows.push([s.full_name, s.institution_id, s.batch_year, s.status, s.updated_at || '']));
            (modalData.participated_no_cert || []).forEach(s => rows.push([s.full_name, s.institution_id, s.batch_year, s.status, s.updated_at || '']));
            (modalData.not_participated || []).forEach(s => rows.push([s.full_name, s.institution_id, s.batch_year, 'not_participated', '']));

            const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${currentEvent.title}_participants.csv`;
            a.click();
        }
    </script>
</body>

</html>