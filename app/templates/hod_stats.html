<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD Dashboard - Department Stats</title>
    <!-- Bootstrap CSS (REQUIRED for grid, tabs, modals, utilities) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom Theme -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Same styling as admin dashboard */
        body {
            background: #f0f2f5;
        }

        .kpi-card {
            background: #fff;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            overflow: hidden;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .kpi-card .kpi-accent {
            width: 5px;
            min-height: 100%;
        }

        .kpi-card .kpi-body {
            padding: 1.25rem 1.5rem;
            flex: 1;
        }

        .kpi-card .kpi-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .kpi-card .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .kpi-card .kpi-subtitle {
            font-size: 0.8rem;
            color: #adb5bd;
            margin-top: 0.25rem;
        }

        .kpi-card .kpi-icon {
            font-size: 2.5rem;
            opacity: 0.15;
            margin-right: 1rem;
        }

        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
            border: none;
            padding: 0.75rem 1.25rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-tabs .nav-link:hover {
            color: #0d6efd;
            border-bottom-color: #dee2e6;
        }

        .nav-tabs .nav-link.active {
            color: #0d6efd;
            font-weight: 600;
            border-bottom-color: #0d6efd;
            background: transparent;
        }

        .filter-bar {
            background: #fff;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .section-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: none;
            overflow: hidden;
        }

        .section-card .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-card .section-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
            color: #212529;
        }

        .section-card .section-body {
            padding: 1.5rem;
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stepper .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .stepper .step.active {
            opacity: 1;
        }

        .stepper .step .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #dee2e6;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .stepper .step.active .step-num {
            background: #0d6efd;
        }

        .stepper .step-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #495057;
        }

        .stepper .step-divider {
            color: #ced4da;
            font-size: 0.75rem;
        }

        .insights-table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
        }

        .insights-table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f3f5;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-primary" href="#">
                <i class="bi bi-patch-check-fill me-2"></i>Certificate Verification
            </a>
            <div class="d-flex gap-2">
                <a href="{{ url_for('main.faculty_dashboard') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-person-workspace me-1"></i>Faculty Dashboard
                </a>
                <a href="{{ url_for('main.logout') }}" class="btn btn-sm btn-danger">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 py-3">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">{{ current_user.department }} Department Statistics</h4>
                <p class="text-muted mb-0 small">Head of Department Analytics</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('main.hod_export_certificates', **request.args) }}"
                    class="btn btn-sm btn-outline-success">
                    <i class="bi bi-download me-1"></i>Export Certificates
                </a>
                <a href="{{ url_for('main.hod_export_students', **request.args) }}"
                    class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-download me-1"></i>Export Students
                </a>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar mb-4">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">Search</label>
                    <input type="text" name="search" class="form-control form-control-sm"
                        placeholder="Name or roll number..." value="{{ request.args.get('search', '') }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted mb-1">Activity Type</label>
                    <select name="activity_type" class="form-select form-select-sm">
                        <option value="">All Types</option>
                        {% for type in activity_types %}
                        <option value="{{ type.id }}" {% if request.args.get('activity_type')==type.id|string
                            %}selected{% endif %}>{{ type.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label small text-muted mb-1">Batch</label>
                    <select name="batch_year" class="form-select form-select-sm">
                        <option value="">All</option>
                        {% for batch in batches %}
                        <option value="{{ batch }}" {% if request.args.get('batch_year')==batch %}selected{% endif %}>{{
                            batch }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted mb-1">Status</label>
                    <select name="status" class="form-select form-select-sm">
                        <option value="">All Statuses</option>
                        <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>
                            Pending</option>
                        <option value="faculty_verified" {% if request.args.get('status')=='faculty_verified'
                            %}selected{% endif %}>Verified</option>
                        <option value="rejected" {% if request.args.get('status')=='rejected' %}selected{% endif %}>
                            Rejected</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted mb-1">Start Date</label>
                    <input type="date" name="start_date" class="form-control form-control-sm"
                        value="{{ request.args.get('start_date', '') }}">
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-sm btn-primary flex-grow-1">
                        <i class="bi bi-funnel me-1"></i>Filter
                    </button>
                    <a href="{{ url_for('main.hod_stats') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
                </div>
            </form>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="hodTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                    type="button" role="tab"><i class="bi bi-grid-1x2-fill me-1"></i>Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button"
                    role="tab"><i class="bi bi-graph-up me-1"></i>Trends</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button"
                    role="tab"><i class="bi bi-table me-1"></i>Detailed Data</button>
            </li>
        </ul>

        <div class="tab-content" id="hodTabContent">

            <!-- ============ OVERVIEW TAB ============ -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">

                <!-- KPI Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card d-flex" onclick="showStatsModal('students')" title="Click to view details">
                            <div class="kpi-accent" style="background:#0d6efd;"></div>
                            <div class="kpi-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="kpi-label">Total Students</div>
                                    <div class="kpi-value text-primary">{{ total_dept_students }}</div>
                                    <div class="kpi-subtitle">In {{ current_user.department }}</div>
                                </div>
                                <i class="bi bi-people-fill kpi-icon text-primary"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card d-flex" onclick="showStatsModal('participants')"
                            title="Click to view details">
                            <div class="kpi-accent" style="background:#198754;"></div>
                            <div class="kpi-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="kpi-label">Participating</div>
                                    <div class="kpi-value text-success">{{ participating_students }}</div>
                                    <div class="kpi-subtitle">
                                        {{ (participating_students / total_dept_students * 100)|round(1) if
                                        total_dept_students > 0 else 0 }}% active
                                    </div>
                                </div>
                                <i class="bi bi-person-check-fill kpi-icon text-success"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card d-flex" onclick="showStatsModal('certificates')"
                            title="Click to view details">
                            <div class="kpi-accent" style="background:#0dcaf0;"></div>
                            <div class="kpi-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="kpi-label">Certificates</div>
                                    <div class="kpi-value" style="color:#0dcaf0;">{{ total_certificates }}</div>
                                    <div class="kpi-subtitle">Total submitted</div>
                                </div>
                                <i class="bi bi-file-earmark-check-fill kpi-icon" style="color:#0dcaf0;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card d-flex" onclick="showStatsModal('verified')" title="Click to view details">
                            <div class="kpi-accent" style="background:#6c757d;"></div>
                            <div class="kpi-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="kpi-label">Verified</div>
                                    <div class="kpi-value" style="color:#6c757d;">{{
                                        status_counts.get('faculty_verified', 0) + status_counts.get('auto_verified', 0)
                                        }}</div>
                                    <div class="kpi-subtitle">Approved certs</div>
                                </div>
                                <i class="bi bi-shield-check kpi-icon" style="color:#6c757d;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second KPI row -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card d-flex">
                            <div class="kpi-accent" style="background:#ffc107;"></div>
                            <div class="kpi-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="kpi-label">Pending</div>
                                    <div class="kpi-value" style="color:#ffc107;">{{ status_counts.get('pending', 0) }}
                                    </div>
                                    <div class="kpi-subtitle">Awaiting review</div>
                                </div>
                                <i class="bi bi-hourglass-split kpi-icon" style="color:#ffc107;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card d-flex">
                            <div class="kpi-accent" style="background:#dc3545;"></div>
                            <div class="kpi-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="kpi-label">Rejected</div>
                                    <div class="kpi-value text-danger">{{ status_counts.get('rejected', 0) }}</div>
                                    <div class="kpi-subtitle">Rejected certs</div>
                                </div>
                                <i class="bi bi-x-circle-fill kpi-icon text-danger"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card d-flex">
                            <div class="kpi-accent" style="background:#fd7e14;"></div>
                            <div class="kpi-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="kpi-label">Activity Types</div>
                                    <div class="kpi-value" style="color:#fd7e14;">{{ activity_types|length }}</div>
                                    <div class="kpi-subtitle">Categories tracked</div>
                                </div>
                                <i class="bi bi-tags-fill kpi-icon" style="color:#fd7e14;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interactive Insights -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h6><i class="bi bi-bar-chart-line-fill me-2 text-primary"></i>Department Insights</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetInsights()">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                        </button>
                    </div>
                    <div class="section-body">
                        <!-- Stepper -->
                        <div class="stepper">
                            <div class="step active" id="step-1">
                                <div class="step-num">1</div>
                                <span class="step-label">Activity Types</span>
                            </div>
                            <i class="bi bi-chevron-right step-divider"></i>
                            <div class="step" id="step-2">
                                <div class="step-num">2</div>
                                <span class="step-label">Events</span>
                            </div>
                        </div>

                        <!-- Level 1: Activity Types -->
                        <div id="level-1-types" class="fade-in">
                            <div class="row g-4">
                                <div class="col-lg-5">
                                    <div
                                        style="background:#f8f9fa; border-radius:12px; padding:1.5rem; height:100%; display:flex; align-items:center; justify-content:center;">
                                        <div style="width:100%; height:260px;">
                                            <canvas id="typeChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                    <table class="table insights-table mb-0">
                                        <thead>
                                            <tr>
                                                <th>Activity Type</th>
                                                <th class="text-center">Count</th>
                                                <th class="text-end">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for t in activity_types %}
                                            <tr>
                                                <td class="fw-medium">{{ t.name }}</td>
                                                <td class="text-center">
                                                    <span class="badge"
                                                        style="background:rgba(13,110,253,0.1); color:#0d6efd; padding:0.4rem 0.8rem; font-size:0.8rem;">
                                                        {{ type_stats.get(t.name, 0) }} activities
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <button class="btn btn-sm btn-outline-primary"
                                                        onclick="loadTypeEvents({{ t.id }}, '{{ t.name }}')">
                                                        Explore <i class="bi bi-arrow-right ms-1"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Level 2: Events -->
                        <div id="level-2-events" style="display:none;" class="fade-in">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Events in <span id="selected-type-name"
                                        class="text-primary fw-bold"></span></h6>
                                <button class="btn btn-sm btn-link text-decoration-none" onclick="resetInsights()">
                                    <i class="bi bi-arrow-left me-1"></i>Back to Types
                                </button>
                            </div>
                            <table class="table insights-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Event Title</th>
                                        <th>Organizer</th>
                                        <th>Date</th>
                                        <th class="text-center">Dept Students</th>
                                        <th class="text-center">Approved</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="events-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div> <!-- End Overview Tab -->

            <!-- ============ TRENDS TAB ============ -->
            <div class="tab-pane fade" id="trends" role="tabpanel">
                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="section-card">
                            <div class="section-header">
                                <h6><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Certificates Over Time</h6>
                            </div>
                            <div class="section-body">
                                <div style="height:350px;">
                                    <canvas id="timeseriesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="section-card">
                            <div class="section-header">
                                <h6><i class="bi bi-pie-chart-fill me-2 text-info"></i>Verification Mode</h6>
                            </div>
                            <div class="section-body">
                                <div style="height:350px;">
                                    <canvas id="modeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============ DETAILED DATA TAB ============ -->
            <div class="tab-pane fade" id="data" role="tabpanel">
                <!-- Student Overview -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h6><i class="bi bi-people me-2 text-primary"></i>Department Students Overview</h6>
                        <span class="badge bg-light text-muted border">{{ dept_students|length }} students</span>
                    </div>
                    <div class="section-body p-0">
                        <div class="table-responsive" style="max-height:500px; overflow-y:auto;">
                            <table class="table insights-table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Roll Number</th>
                                        <th>Batch</th>
                                        <th class="text-center">Certificates</th>
                                        <th class="text-center">Verified</th>
                                        <th class="text-center">Pending</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for s in dept_students %}
                                    <tr>
                                        <td class="fw-medium">{{ s.full_name }}</td>
                                        <td>{{ s.institution_id }}</td>
                                        <td>{{ s.batch_year }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-light text-dark border">{{ s.total_certs }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">{{ s.verified }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning text-dark">{{ s.pending }}</span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">No students found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Detailed Certificates -->
                <div class="section-card mb-4">
                    <div class="section-header">
                        <h6><i class="bi bi-file-earmark-text me-2 text-info"></i>Detailed Certificates</h6>
                        <span class="badge bg-light text-muted border">{{ detailed_certs|length }} records</span>
                    </div>
                    <div class="section-body p-0">
                        <div class="table-responsive" style="max-height:500px; overflow-y:auto;">
                            <table class="table insights-table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Batch</th>
                                        <th>Activity</th>
                                        <th>Issue Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in detailed_certs %}
                                    <tr>
                                        <td>
                                            <div class="fw-medium">{{ c.full_name }}</div>
                                            <small class="text-muted">{{ c.institution_id }}</small>
                                        </td>
                                        <td>{{ c.batch_year }}</td>
                                        <td>
                                            <strong>{{ c.title }}</strong><br>
                                            <small class="text-muted">{{ c.type_name }} | {{ c.organizer }}</small>
                                        </td>
                                        <td>{{ c.issue_date }}</td>
                                        <td>
                                            <span
                                                class="badge {{ 'bg-success' if c.status == 'faculty_verified' else 'bg-warning text-dark' if c.status == 'pending' else 'bg-danger' }}">
                                                {{ c.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">No certificates found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div> <!-- End Data Tab -->

        </div> <!-- End Tab Content -->

        <!-- Stats Modal -->
        <div class="modal fade" id="statsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-light">
                        <h6 class="modal-title fw-bold" id="statsModalTitle">Details</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive" style="max-height:400px; overflow-y:auto;">
                            <table class="table insights-table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Roll Number</th>
                                        <th>Batch</th>
                                        <th>Status</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody id="statsModalBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End container -->

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let typeChart = null;

        const typeData = [
            {% for t in activity_types %}
        { id: { { t.id } }, name: "{{ t.name }}" },
        {% endfor %}
        ];

        const typeStats = {
            {% for name, count in type_stats.items() %}
        "{{ name }}": { { count } },
        {% endfor %}
        };

        document.addEventListener('DOMContentLoaded', function () {
            initTypeChart();

            document.querySelectorAll('#hodTabs button').forEach(btn => {
                btn.addEventListener('shown.bs.tab', function (e) {
                    if (e.target.id === 'trends-tab') {
                        loadTrendsData();
                    }
                });
            });
        });

        function initTypeChart() {
            const labels = typeData.map(t => t.name);
            const data = typeData.map(t => typeStats[t.name] || 0);

            if (typeChart) typeChart.destroy();

            const colors = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'];

            typeChart = new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true } }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const type = typeData[idx];
                            loadTypeEvents(type.id, type.name);
                        }
                    }
                }
            });
        }

        function updateStepper(step) {
            for (let i = 1; i <= 2; i++) {
                const el = document.getElementById('step-' + i);
                if (i <= step) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            }
        }

        function resetInsights() {
            document.getElementById('level-1-types').style.display = 'block';
            document.getElementById('level-2-events').style.display = 'none';
            updateStepper(1);
        }

        function loadTypeEvents(typeId, typeName) {
            document.getElementById('level-1-types').style.display = 'none';
            document.getElementById('level-2-events').style.display = 'block';
            document.getElementById('selected-type-name').textContent = typeName;
            updateStepper(2);

            const dept = '{{ current_user.department }}';

            fetch(`/api/insights/department/${encodeURIComponent(dept)}/activity_type/${typeId}/events`)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('events-table-body');
                    if (!data.events || data.events.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4"><i class="bi bi-inbox me-2"></i>No events found for this category.</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.events.map(e => `
                        <tr>
                            <td class="fw-medium">${e.title}</td>
                            <td class="text-muted">${e.organizer}</td>
                            <td class="text-muted small">${e.date}</td>
                            <td class="text-center"><span class="badge bg-light text-dark border">${e.dept_student_count}</span></td>
                            <td class="text-center"><span class="badge bg-success">${e.dept_approved_count}</span></td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-info text-white" onclick="showEventStudents('${encodeURIComponent(e.event_key)}', '${e.title}')">
                                    View List <i class="bi bi-list-ul ms-1"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                });
        }

        function showEventStudents(eventKey, eventTitle) {
            const dept = '{{ current_user.department }}';
            document.getElementById('statsModalTitle').textContent = `${dept} Students in ${eventTitle}`;
            document.getElementById('statsModalBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm me-2"></div>Loading...</td></tr>';
            new bootstrap.Modal(document.getElementById('statsModal')).show();

            fetch(`/api/insights/department/${encodeURIComponent(dept)}/event/${eventKey}/students`)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('statsModalBody');
                    if (!data.students || data.students.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No students found.</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.students.map(s => `
                        <tr>
                            <td>${s.name}</td>
                            <td>${s.roll_number}</td>
                            <td>${s.year}</td>
                            <td><span class="badge bg-${s.certificate_status === 'Faculty Verified' ? 'success' : 'secondary'}">${s.certificate_status || s.participation_status}</span></td>
                            <td>${s.last_updated}</td>
                        </tr>
                    `).join('');
                });
        }

        let timeseriesChart = null;
        let modeChart = null;

        function loadTrendsData() {
            const params = new URLSearchParams(window.location.search);

            fetch(`/api/insights/certificates-timeseries?${params.toString()}`)
                .then(r => r.json())
                .then(data => initTimeseriesChart(data));

            fetch(`/api/insights/certificate-metrics?${params.toString()}`)
                .then(r => r.json())
                .then(data => initModeChart(data.verification_mode_distribution));
        }

        function initTimeseriesChart(data) {
            if (timeseriesChart) timeseriesChart.destroy();
            const ctx = document.getElementById('timeseriesChart').getContext('2d');
            timeseriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [
                        { label: 'Submitted', data: data.submitted, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', fill: true, tension: 0.4 },
                        { label: 'Approved', data: data.approved, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', fill: true, tension: 0.4 },
                        { label: 'Rejected', data: data.rejected, borderColor: '#dc3545', fill: false, tension: 0.4 },
                        { label: 'Pending', data: data.pending, borderColor: '#ffc107', fill: false, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function initModeChart(dist) {
            if (modeChart) modeChart.destroy();
            const ctx = document.getElementById('modeChart').getContext('2d');

            // Combine auto_verified and faculty_verified per user request
            const verified = (dist.auto_verified || 0) + (dist.faculty_verified || 0);

            modeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Verified'],
                    datasets: [{
                        data: [verified],
                        backgroundColor: ['#198754'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Verified: ${context.parsed} (${dist.auto_verified || 0} auto + ${dist.faculty_verified || 0} manual)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function showStatsModal(type) {
            const titles = {
                'students': 'All Department Students',
                'participants': 'Participating Students',
                'certificates': 'All Certificates',
                'verified': 'Verified Certificates'
            };
            document.getElementById('statsModalTitle').textContent = titles[type] || 'Details';
            new bootstrap.Modal(document.getElementById('statsModal')).show();
        }
    </script>
</body>

</html>