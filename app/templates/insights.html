<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights & Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .kpi-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .filter-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .drill-nav {
            margin-bottom: 15px;
        }

        .breadcrumb-item a {
            text-decoration: none;
        }

        .student-modal .modal-dialog {
            max-width: 900px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="bi bi-patch-check-fill"></i> Certificate System
            </a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.index') }}">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link active" href="#">Insights</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.logout') }}">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <h3 class="mb-4"><i class="bi bi-graph-up"></i> Insights & Analytics</h3>

        <!-- Filters -->
        <div class="filter-bar">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label class="form-label small mb-1">Date From</label>
                    <input type="date" id="dateFrom" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Date To</label>
                    <input type="date" id="dateTo" class="form-control form-control-sm">
                </div>
                {% if current_user.role == 'admin' %}
                <div class="col-md-3">
                    <label class="form-label small mb-1">Department</label>
                    <select id="deptFilter" class="form-control form-control-sm">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-3">
                    <label class="form-label small mb-1">&nbsp;</label>
                    <button class="btn btn-primary btn-sm d-block w-100" onclick="applyFilters()">
                        <i class="bi bi-funnel"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card kpi-card text-white bg-primary h-100">
                    <div class="card-body text-center">
                        <div class="kpi-value" id="kpiSubmitted">-</div>
                        <div class="kpi-label">Submitted</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card kpi-card text-white bg-success h-100">
                    <div class="card-body text-center">
                        <div class="kpi-value" id="kpiApproved">-</div>
                        <div class="kpi-label">Approved</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card kpi-card text-white bg-danger h-100">
                    <div class="card-body text-center">
                        <div class="kpi-value" id="kpiRejected">-</div>
                        <div class="kpi-label">Rejected</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card kpi-card text-white bg-warning h-100">
                    <div class="card-body text-center">
                        <div class="kpi-value" id="kpiPending">-</div>
                        <div class="kpi-label">Pending</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card kpi-card text-white bg-info h-100">
                    <div class="card-body text-center">
                        <div class="kpi-value" id="kpiAvgTime">-</div>
                        <div class="kpi-label">Avg Hours</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card kpi-card text-white bg-secondary h-100">
                    <div class="card-body text-center">
                        <div class="kpi-value" id="kpiAutoVerified">-</div>
                        <div class="kpi-label">Auto-Verified</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up-arrow"></i> Certificates Over Time
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="timeseriesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> Verification Mode
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="modeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Drill-Down -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-building"></i>
                    <span id="drilldownTitle">Department Overview</span>
                </span>
                <nav id="drilldownBreadcrumb" class="drill-nav" style="display:none;">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="#" onclick="showDepartments(); return false;">All
                                Departments</a></li>
                        <li class="breadcrumb-item active" id="breadcrumbDept"></li>
                    </ol>
                </nav>
                <div class="col-auto" id="eventDropdownContainer" style="display:none;">
                    <select id="eventQuickSelect" class="form-select form-select-sm">
                        <option value="">-- Jump to Event --</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="drilldownChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Student List Modal -->
    <div class="modal fade student-modal" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalTitle">Event Students</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" id="studentSearch" class="form-control form-control-sm"
                                placeholder="Search name/roll...">
                        </div>
                        <div class="col-md-2">
                            <select id="studentYearFilter" class="form-control form-control-sm">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="studentParticipationFilter" class="form-control form-control-sm">
                                <option value="">All Participation</option>
                                <option value="participated_submitted">Participated + Submitted</option>
                                <option value="not_participated">Not Participated</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="studentCertFilter" class="form-control form-control-sm">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="auto_verified">Auto Verified</option>
                                <option value="faculty_verified">Faculty Verified</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex gap-2">
                            <button class="btn btn-primary btn-sm flex-grow-1" onclick="loadEventStudents()">
                                <i class="bi bi-search"></i> Filter
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportEventStudents()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <span class="badge bg-success" id="statParticipated">Participated: 0</span>
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-secondary" id="statNotParticipated">Not Participated: 0</span>
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-primary" id="statTotal">Total: 0</span>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Roll Number</th>
                                    <th>Year</th>
                                    <th>Participation</th>
                                    <th>Certificate Status</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav>
                        <ul class="pagination justify-content-center" id="studentPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let timeseriesChart, modeChart, drilldownChart;
        let currentDept = null, currentEventKey = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Set default dates (last 12 months)
            const now = new Date();
            const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            document.getElementById('dateTo').value = now.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = yearAgo.toISOString().split('T')[0];

            loadMetrics();
            loadTimeseries();
            loadDepartments();
        });

        function getFilters() {
            const params = new URLSearchParams();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const dept = document.getElementById('deptFilter')?.value;
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            if (dept) params.append('department', dept);
            return params;
        }

        function applyFilters() {
            loadMetrics();
            loadTimeseries();
            if (!currentDept) loadDepartments();
        }

        // KPI Metrics
        function loadMetrics() {
            fetch(`/api/insights/certificate-metrics?${getFilters()}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('kpiSubmitted').textContent = data.total_submitted;
                    document.getElementById('kpiApproved').textContent = data.total_approved;
                    document.getElementById('kpiRejected').textContent = data.total_rejected;
                    document.getElementById('kpiPending').textContent = data.total_pending;
                    document.getElementById('kpiAvgTime').textContent = data.avg_verification_time_hours.toFixed(1);
                    document.getElementById('kpiAutoVerified').textContent = data.total_auto_verified;

                    // Update pie chart
                    updateModeChart(data.verification_mode_distribution);
                })
                .catch(err => console.error('Metrics error:', err));
        }

        // Time Series Chart
        function loadTimeseries() {
            fetch(`/api/insights/certificates-timeseries?${getFilters()}`)
                .then(r => r.json())
                .then(data => {
                    if (timeseriesChart) timeseriesChart.destroy();

                    const ctx = document.getElementById('timeseriesChart').getContext('2d');
                    timeseriesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.months,
                            datasets: [
                                { label: 'Submitted', data: data.submitted, borderColor: '#0d6efd', fill: false, tension: 0.3 },
                                { label: 'Approved', data: data.approved, borderColor: '#198754', fill: false, tension: 0.3 },
                                { label: 'Rejected', data: data.rejected, borderColor: '#dc3545', fill: false, tension: 0.3 },
                                { label: 'Pending', data: data.pending, borderColor: '#ffc107', fill: false, tension: 0.3 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                })
                .catch(err => console.error('Timeseries error:', err));
        }

        // Mode Pie Chart
        function updateModeChart(dist) {
            if (modeChart) modeChart.destroy();

            const ctx = document.getElementById('modeChart').getContext('2d');
            modeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Auto Verified', 'Faculty Verified'],
                    datasets: [{
                        data: [dist.auto_verified || 0, dist.faculty_verified || 0],
                        backgroundColor: ['#0dcaf0', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // Department Bar Chart (Level 1)
        function loadDepartments() {
            currentDept = null;
            document.getElementById('drilldownTitle').textContent = 'Department Overview';
            document.getElementById('drilldownBreadcrumb').style.display = 'none';

            fetch('/api/insights/departments')
                .then(r => r.json())
                .then(data => {
                    if (drilldownChart) drilldownChart.destroy();

                    const labels = data.departments.map(d => d.department);
                    const values = data.departments.map(d => d.participating_students);

                    const ctx = document.getElementById('drilldownChart').getContext('2d');
                    drilldownChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Participating Students',
                                data: values,
                                backgroundColor: '#0d6efd'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (e, elements) => {
                                if (elements.length > 0) {
                                    const idx = elements[0].index;
                                    showDepartmentEvents(labels[idx]);
                                }
                            },
                            plugins: {
                                tooltip: { callbacks: { title: (items) => `Click to drill down: ${items[0].label}` } }
                            }
                        }
                    });
                })
                .catch(err => console.error('Departments error:', err));
        }

        // Populate dropdown with all events
        function populateEventDropdown(events, dept) {
            const select = document.getElementById('eventQuickSelect');
            const container = document.getElementById('eventDropdownContainer');

            if (events && events.length > 10) {  // Only show if many events
                select.innerHTML = '<option value="">-- Jump to Event --</option>' +
                    events.map((e, idx) => `<option value="${idx}">${e.title}</option>`).join('');

                select.onchange = function () {
                    const idx = parseInt(this.value);
                    if (!isNaN(idx)) {
                        const event = events[idx];
                        showEventStudents(dept, event.event_key, event.title);
                    }
                };

                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // Events Bar Chart (Level 2)
        function showDepartmentEvents(dept) {
            currentDept = dept;
            document.getElementById('drilldownTitle').textContent = `${dept} Events (Click any bar)`;
            document.getElementById('drilldownBreadcrumb').style.display = 'block';
            document.getElementById('breadcrumbDept').textContent = dept;

            fetch(`/api/insights/department/${encodeURIComponent(dept)}/events`)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    if (!data.events || data.events.length === 0) {
                        alert(`No events found for ${dept}`);
                        loadDepartments();
                        return;
                    }

                    if (drilldownChart) drilldownChart.destroy();

                    // Show ALL events (remove .slice limitation)
                    const events = data.events;

                    // Populate Dropdown
                    populateEventDropdown(events, dept);

                    // Truncate long titles for display
                    const labels = events.map(e => {
                        const short = e.title.substring(0, 30);
                        return e.title.length > 30 ? short + '...' : short;
                    });

                    const values = events.map(e => e.participating_students);

                    const ctx = document.getElementById('drilldownChart').getContext('2d');
                    drilldownChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Participating Students',
                                data: values,
                                backgroundColor: '#198754',
                                hoverBackgroundColor: '#146c43'
                            }]
                        },
                        options: {
                            // âœ… REMOVED indexAxis: 'y' - now VERTICAL bars
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (e, elements) => {
                                if (elements.length > 0) {
                                    const idx = elements[0].index;
                                    const event = events[idx];
                                    console.log('Event clicked:', event);  // Debug log
                                    showEventStudents(dept, event.event_key, event.title);
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: (items) => `${events[items[0].dataIndex].title}`,
                                        afterTitle: () => 'ðŸ‘† Click to view student list',
                                        label: (item) => `${item.formattedValue} students`
                                    }
                                },
                                legend: { display: false }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45,
                                        font: { size: 10 }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Students' }
                                }
                            }
                        }
                    });

                    // Add a helper message
                    const chartCard = document.querySelector('#drilldownChart').closest('.card-body');
                    let helperMsg = chartCard.querySelector('.helper-message');
                    if (!helperMsg) {
                        helperMsg = document.createElement('div');
                        helperMsg.className = 'helper-message alert alert-info mt-2';
                        chartCard.appendChild(helperMsg);
                    }
                    helperMsg.innerHTML = `<i class="bi bi-info-circle"></i> <strong>${events.length} events found.</strong> Click any bar to view students.`;
                })
                .catch(err => {
                    console.error('Events API error:', err);
                    alert(`Failed to load events for ${dept}. Error: ${err.message}`);
                    loadDepartments();
                });
        }

        function showDepartments() {
            loadDepartments();
        }

        // Student Modal
        function showEventStudents(dept, eventKey, title) {
            currentDept = dept;
            currentEventKey = eventKey;

            // Open modal immediately with loading state
            const modal = new bootstrap.Modal(document.getElementById('studentModal'));
            modal.show();

            // Update title
            document.getElementById('studentModalTitle').innerHTML = `<div class="spinner-border spinner-border-sm me-2"></div> Loading students for: ${title}`;

            // Clear previous data
            document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border"></div> Loading students...</td></tr>';
            document.getElementById('studentPagination').innerHTML = '';

            // Reset filters
            document.getElementById('studentSearch').value = '';
            document.getElementById('studentYearFilter').value = '';
            document.getElementById('studentParticipationFilter').value = '';
            document.getElementById('studentCertFilter').value = '';

            // Load data
            loadEventStudents(1)
                .then(() => {
                    // Remove loading spinner from title
                    document.getElementById('studentModalTitle').textContent = `Students: ${title}`;
                })
                .catch(err => {
                    document.getElementById('studentModalTitle').textContent = `Error loading: ${title}`;
                    document.getElementById('studentTableBody').innerHTML = `
                        <tr><td colspan="6" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Failed to load students: ${err.message}
                        </td></tr>
                    `;
                });
        }

        function loadEventStudents(page = 1) {
            const params = new URLSearchParams({
                search: document.getElementById('studentSearch').value,
                year: document.getElementById('studentYearFilter').value,
                participation_status: document.getElementById('studentParticipationFilter').value,
                certificate_status: document.getElementById('studentCertFilter').value,
                page: page
            });

            // Show loading in table
            document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';

            return fetch(`/api/insights/department/${encodeURIComponent(currentDept)}/event/${encodeURIComponent(currentEventKey)}/students?${params}`)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    // Update stats
                    document.getElementById('statParticipated').textContent = `Participated: ${data.stats.participated_submitted || 0}`;
                    document.getElementById('statNotParticipated').textContent = `Not Participated: ${data.stats.not_participated || 0}`;
                    document.getElementById('statTotal').textContent = `Total: ${data.total || 0}`;

                    // Render table
                    const tbody = document.getElementById('studentTableBody');
                    if (!data.students || data.students.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No students found for this event.</td></tr>';
                        document.getElementById('studentPagination').innerHTML = '';
                        return;
                    }

                    tbody.innerHTML = data.students.map(s => `
                        <tr>
                            <td>${s.name}</td>
                            <td>${s.roll_number}</td>
                            <td>${s.year}</td>
                            <td>
                                <span class="badge ${s.participation_status.includes('Submitted') ? 'bg-success' : 'bg-secondary'}">
                                    ${s.participation_status}
                                </span>
                            </td>
                            <td>
                                ${s.certificate_status ? `<span class="badge bg-${getStatusColor(s.certificate_status)}">${s.certificate_status}</span>` : '-'}
                            </td>
                            <td>${s.last_updated || '-'}</td>
                        </tr>
                    `).join('');

                    // Render pagination
                    renderPagination(data.page, data.total_pages);
                })
                .catch(err => {
                    console.error('Students API error:', err);
                    document.getElementById('studentTableBody').innerHTML = `
                        <tr><td colspan="6" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error: ${err.message}. Please try again.
                        </td></tr>
                    `;
                    throw err;  // Re-throw for caller to handle
                });
        }

        function getStatusColor(status) {
            const colors = {
                'Pending': 'warning',
                'Auto Verified': 'info',
                'Faculty Verified': 'success',
                'Rejected': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function renderPagination(current, total) {
            const ul = document.getElementById('studentPagination');
            let html = '';
            if (current > 1) html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEventStudents(${current - 1}); return false;">Prev</a></li>`;
            for (let p = Math.max(1, current - 2); p <= Math.min(total, current + 2); p++) {
                html += `<li class="page-item ${p === current ? 'active' : ''}"><a class="page-link" href="#" onclick="loadEventStudents(${p}); return false;">${p}</a></li>`;
            }
            if (current < total) html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEventStudents(${current + 1}); return false;">Next</a></li>`;
            ul.innerHTML = html;
        }

        function exportEventStudents() {
            const params = new URLSearchParams({
                search: document.getElementById('studentSearch').value,
                year: document.getElementById('studentYearFilter').value,
                participation_status: document.getElementById('studentParticipationFilter').value,
                certificate_status: document.getElementById('studentCertFilter').value
            });
            window.location.href = `/api/insights/department/${encodeURIComponent(currentDept)}/event/${encodeURIComponent(currentEventKey)}/students/export?${params}`;
        }
    </script>
</body>

</html>